{% extends 'base.html' %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <a href="{% url 'document_list' %}" class="btn btn-outline-secondary">&larr; Back to List</a>
    </div>
</div>

<div class="row">
    <!-- Main Text Column -->
    <div class="col-lg-7">
        <div class="card mb-4">
            <div class="card-body">
                <h2 class="card-title">{{ object.title }}</h2>
                <div class="mb-3">
                    <span class="badge bg-primary">{{ object.category.name }}</span>
                    {% for tag in object.tags.all %}
                    <span class="badge bg-info text-dark">{{ tag.name }}</span>
                    {% endfor %}
                    <span class="text-muted ms-2">{{ object.created_at|date:"F d, Y H:i" }}</span>
                </div>
                
                <h6 class="mt-4">Analyzed Text Content</h6>
                
                <!-- Scrollable Container with Fixed Height -->
                <div class="card-text border p-3 bg-light rounded" style="max-height: 500px; overflow-y: auto; line-height: 2.0;">
                    {% for item in metrics.reading.highlighted_sentences %}
                        <span 
                            style="background-color: rgba(220, 53, 69, {{ item.opacity }}); padding: 0 2px; border-radius: 3px;" 
                            title="Complexity Score: {{ item.complexity_score }}/10"
                            data-bs-toggle="tooltip">
                            {{ item.text|safe }}
                        </span>
                    {% endfor %}
                </div>
                
                <div class="d-flex justify-content-between mt-2">
                    <p class="text-muted"><small>* Darker red background = Higher sentence complexity.</small></p>
                    <p class="text-muted"><small>* <strong class="text-primary">Bold Blue</strong> text = Frequently recurring words.</small></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Analysis Tabs Column -->
    <div class="col-lg-5">
        <div class="card mb-4">
            <div class="card-header bg-dark text-white p-2">
                <ul class="nav nav-tabs card-header-tabs" id="analysisTabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#general" type="button">General</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#reading" type="button">Reading</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#lexical" type="button">Lexical</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#advanced" type="button">Nerd Stats</button>
                    </li>
                </ul>
            </div>
            
            <div class="card-body">
                <div class="tab-content">
                    
                    <!-- 1. General Tab -->
                    <div class="tab-pane fade show active" id="general">
                        <h6 class="border-bottom pb-2">Basic Counters</h6>
                        <ul class="list-group list-group-flush mb-3">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Word Count</span>
                                <strong>{{ metrics.general.word_count }}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Sentence Count</span>
                                <strong>{{ metrics.general.sentence_count }}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Consonants/Word</span>
                                <strong>{{ metrics.general.avg_consonants }}</strong>
                            </li>
                        </ul>
                        
                        <h6 class="border-bottom pb-2">Sentiment Analysis (VADER)</h6>
                        <div class="row text-center mt-2">
                            <div class="col-4">
                                <small class="d-block text-muted">Positive</small>
                                <span class="text-success">{{ metrics.general.sentiment.pos }}</span>
                            </div>
                            <div class="col-4">
                                <small class="d-block text-muted">Neutral</small>
                                <span class="text-secondary">{{ metrics.general.sentiment.neu }}</span>
                            </div>
                            <div class="col-4">
                                <small class="d-block text-muted">Negative</small>
                                <span class="text-danger">{{ metrics.general.sentiment.neg }}</span>
                            </div>
                        </div>
                        <div class="alert alert-secondary mt-2 text-center p-1">
                            Compound Score: <strong>{{ metrics.general.sentiment.compound }}</strong>
                        </div>
                    </div>

                    <!-- 2. Reading Tab -->
                    <div class="tab-pane fade" id="reading">
                        <h6 class="border-bottom pb-2">Readability Scores</h6>
                        <div class="mb-3">
                            <label>Flesch Reading Ease</label>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar bg-info" role="progressbar" 
                                     style="width: {{ metrics.reading.flesch_score }}%;" 
                                     aria-valuenow="{{ metrics.reading.flesch_score }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    {{ metrics.reading.flesch_score }}
                                </div>
                            </div>
                            <small class="text-muted">0-30: Very Confusing | 90-100: Very Easy</small>
                        </div>

                        <h6 class="border-bottom pb-2">Text Cohesion</h6>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Jaccard Index (Avg sentence overlap):</span>
                            <strong>{{ metrics.reading.avg_jaccard }}</strong>
                        </div>
                        <small class="text-muted">Higher values indicate better flow between sentences (words repeating in adjacent sentences).</small>
                    </div>

                    <!-- 3. Lexical Tab -->
                    <div class="tab-pane fade" id="lexical">
                        <div class="row mb-3">
                            <div class="col-6 text-center border-end">
                                <h6>Lexical Diversity</h6>
                                <h4 class="text-primary">{{ metrics.lexical.diversity }}</h4>
                                <small>Unique words ratio</small>
                            </div>
                            <div class="col-6 text-center">
                                <h6>Content Words</h6>
                                <h4 class="text-primary">{{ metrics.lexical.content_ratio }}</h4>
                                <small>Nouns/Verbs density</small>
                            </div>
                        </div>

                        {% if metrics.lexical.pos_graph %}
                            <h6 class="border-top pt-2">Part of Speech Distribution</h6>
                            <img src="data:image/png;base64,{{ metrics.lexical.pos_graph }}" class="img-fluid rounded border mb-3" alt="POS Chart">
                        {% endif %}

                        {% if metrics.lexical.len_graph %}
                            <h6 class="border-top pt-2">Word Length frequency</h6>
                            <img src="data:image/png;base64,{{ metrics.lexical.len_graph }}" class="img-fluid rounded border" alt="Word Length Chart">
                        {% endif %}
                    </div>

                    <!-- 4. Advanced Tab -->
                    <div class="tab-pane fade" id="advanced">
                        <h6 class="border-bottom pb-2">Frequent N-grams (Repeating > 1)</h6>
                        <div class="row">
                            <div class="col-6">
                                <strong>Bigrams:</strong>
                                <ul class="list-unstyled small">
                                    {% for bg in metrics.advanced.bigrams %}
                                        <li>• {{ bg }}</li>
                                    {% empty %}
                                        <li class="text-muted">None found</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <div class="col-6">
                                <strong>Trigrams:</strong>
                                <ul class="list-unstyled small">
                                    {% for tg in metrics.advanced.trigrams %}
                                        <li>• {{ tg }}</li>
                                    {% empty %}
                                        <li class="text-muted">None found</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>

                        <h6 class="border-bottom pb-2 mt-3">Named Entities Found</h6>
                        <div class="d-flex flex-wrap gap-1">
                            {% for entity in metrics.advanced.entities %}
                                <span class="badge bg-secondary">{{ entity }}</span>
                            {% empty %}
                                <span class="text-muted small">No named entities detected.</span>
                            {% endfor %}
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}